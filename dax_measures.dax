-- =============================================================================
-- MEDIDAS DAX â€” Dashboard EstratÃ©gico de Riesgo Crediticio
-- Copiar cada medida en Power BI: Modelado â†’ Nueva Medida
-- =============================================================================

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š SECCIÃ“N 1: KPIs PRINCIPALES (PÃ¡gina Resumen Ejecutivo)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 1.1 Tasa de Morosidad (Default Rate) â€” LA MÃ‰TRICA MÃS IMPORTANTE
-- QuÃ© mide: % de crÃ©ditos clasificados como "Bad" sobre el total
Tasa_Morosidad = 
DIVIDE(
    CALCULATE(
        COUNTROWS(Fact_Prestamos),
        Fact_Prestamos[Estado_Riesgo] = "Bad"
    ),
    COUNTROWS(Fact_Prestamos),
    0
)
-- Formato: Porcentaje | Target: < 20% | Alerta: > 30%


-- 1.2 Monto Total Prestado
Total_Prestado = 
SUM(Fact_Prestamos[Monto])
-- Formato: Moneda (DM) | Tipo: Tarjeta KPI


-- 1.3 ExposiciÃ³n al Riesgo (Total Risk Exposure)
-- QuÃ© mide: Monto total de crÃ©ditos en mora (cuÃ¡nto perderÃ­amos)
Monto_Riesgo = 
CALCULATE(
    SUM(Fact_Prestamos[Monto]),
    Fact_Prestamos[Estado_Riesgo] = "Bad"
)
-- Formato: Moneda (DM) | Color: Rojo


-- 1.4 Total CrÃ©ditos
Total_Creditos = COUNTROWS(Fact_Prestamos)
-- Formato: NÃºmero entero


-- 1.5 CrÃ©ditos Buenos vs Malos
Creditos_Buenos = 
CALCULATE(
    COUNTROWS(Fact_Prestamos),
    Fact_Prestamos[Estado_Riesgo] = "Good"
)

Creditos_Malos = 
CALCULATE(
    COUNTROWS(Fact_Prestamos),
    Fact_Prestamos[Estado_Riesgo] = "Bad"
)


-- 1.6 Monto Promedio por CrÃ©dito
Monto_Promedio = AVERAGE(Fact_Prestamos[Monto])
-- Formato: Moneda


-- 1.7 Ratio de Riesgo (% del monto total que estÃ¡ en riesgo)
Ratio_Riesgo = 
DIVIDE(
    [Monto_Riesgo],
    [Total_Prestado],
    0
)
-- Formato: Porcentaje | Insight: Si es > 35%, la cartera estÃ¡ en peligro


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“ˆ SECCIÃ“N 2: ANÃLISIS TEMPORAL
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 2.1 Tasa de Morosidad del Mes Anterior (para comparaciÃ³n)
Tasa_Morosidad_MesAnterior = 
CALCULATE(
    [Tasa_Morosidad],
    DATEADD(Dim_Tiempo[Fecha], -1, MONTH)
)

-- 2.2 VariaciÃ³n Mensual de Morosidad (MoM)
Variacion_Morosidad_MoM = 
VAR TasaActual = [Tasa_Morosidad]
VAR TasaAnterior = [Tasa_Morosidad_MesAnterior]
RETURN
    IF(
        NOT ISBLANK(TasaAnterior),
        TasaActual - TasaAnterior,
        BLANK()
    )
-- Formato: Porcentaje con flechas â†‘â†“


-- 2.3 CrÃ©ditos Acumulados (Running Total)
Creditos_Acumulados = 
CALCULATE(
    COUNTROWS(Fact_Prestamos),
    FILTER(
        ALL(Dim_Tiempo),
        Dim_Tiempo[Fecha] <= MAX(Dim_Tiempo[Fecha])
    )
)


-- 2.4 Monto Prestado por Trimestre
Monto_Trimestral = 
CALCULATE(
    SUM(Fact_Prestamos[Monto]),
    ALLEXCEPT(Dim_Tiempo, Dim_Tiempo[Trimestre], Dim_Tiempo[Anio])
)


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ¯ SECCIÃ“N 3: SCORE Y SEGMENTACIÃ“N
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 3.1 Score Promedio de Clientes
Score_Promedio = AVERAGE(Fact_Prestamos[Score_Cliente])
-- Formato: NÃºmero con 0 decimales


-- 3.2 Score Promedio de Buenos Pagadores
Score_Buenos = 
CALCULATE(
    AVERAGE(Fact_Prestamos[Score_Cliente]),
    Fact_Prestamos[Estado_Riesgo] = "Good"
)

-- 3.3 Score Promedio de Morosos
Score_Malos = 
CALCULATE(
    AVERAGE(Fact_Prestamos[Score_Cliente]),
    Fact_Prestamos[Estado_Riesgo] = "Bad"
)

-- 3.4 Brecha de Score (diferencia entre buenos y malos)
Brecha_Score = [Score_Buenos] - [Score_Malos]
-- Insight: Una brecha grande significa que el score es buen predictor


-- 3.5 DuraciÃ³n Promedio del CrÃ©dito
Duracion_Promedio = AVERAGE(Fact_Prestamos[Duracion])
-- Formato: "#0 meses"


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” SECCIÃ“N 4: ANÃLISIS AVANZADO (Para PÃ¡gina Analista)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 4.1 Tasa de Morosidad por Rango de Edad (para Decomposition Tree)
Morosidad_Jovenes = 
CALCULATE(
    [Tasa_Morosidad],
    Dim_Cliente[Rango_Edad] = "18-25 (Joven)"
)

-- 4.2 ConcentraciÃ³n de Riesgo por PropÃ³sito
-- QuÃ© mide: Â¿QuÃ© % del riesgo total representa cada propÃ³sito?
Concentracion_Riesgo = 
DIVIDE(
    CALCULATE(
        SUM(Fact_Prestamos[Monto]),
        Fact_Prestamos[Estado_Riesgo] = "Bad"
    ),
    CALCULATE(
        SUM(Fact_Prestamos[Monto]),
        Fact_Prestamos[Estado_Riesgo] = "Bad",
        ALL(Dim_Proposito)
    ),
    0
)
-- Formato: Porcentaje | Usar en: GrÃ¡fico de dona


-- 4.3 Ãndice de Riesgo Relativo
-- Compara la tasa de morosidad del segmento vs la tasa global
Indice_Riesgo_Relativo = 
VAR TasaSegmento = [Tasa_Morosidad]
VAR TasaGlobal = CALCULATE([Tasa_Morosidad], ALL(Fact_Prestamos))
RETURN
    DIVIDE(TasaSegmento, TasaGlobal, 0)
-- InterpretaciÃ³n: >1 = Mayor riesgo que el promedio, <1 = Menor riesgo


-- 4.4 PÃ©rdida Esperada (Expected Loss)
-- FÃ³rmula bancaria: PD Ã— LGD Ã— EAD (simplificada)
Perdida_Esperada = 
[Tasa_Morosidad] * 0.45 * SUM(Fact_Prestamos[Monto])
-- 0.45 = Loss Given Default asumido (45% estÃ¡ndar Basilea II)
-- Formato: Moneda


-- 4.5 Tasa de AprobaciÃ³n Sugerida
-- Si rechazÃ¡ramos todos los Score < 550, Â¿cuÃ¡ntos quedarÃ­an?
Tasa_Aprobacion_Sugerida = 
DIVIDE(
    CALCULATE(
        COUNTROWS(Fact_Prestamos),
        Fact_Prestamos[Score_Cliente] >= 550
    ),
    COUNTROWS(Fact_Prestamos),
    0
)


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“‹ SECCIÃ“N 5: TABLAS CALCULADAS (Crear en Modelado â†’ Nueva Tabla)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 5.1 Tabla de Umbrales de Riesgo (para formato condicional)
Umbrales_Riesgo = 
DATATABLE(
    "Nivel", STRING,
    "Limite_Inferior", DOUBLE,
    "Limite_Superior", DOUBLE,
    "Color", STRING,
    {
        {"Bajo",     0.00, 0.15, "#2ECC71"},
        {"Medio",    0.15, 0.25, "#F39C12"},
        {"Alto",     0.25, 0.35, "#E67E22"},
        {"CrÃ­tico",  0.35, 1.00, "#E74C3C"}
    }
)

-- 5.2 Tabla Calendario (si Dim_Tiempo no funciona bien)
Calendario = 
ADDCOLUMNS(
    CALENDAR(DATE(2023,1,1), DATE(2025,12,31)),
    "Anio", YEAR([Date]),
    "Mes", MONTH([Date]),
    "NombreMes", FORMAT([Date], "MMMM"),
    "Trimestre", "Q" & FORMAT([Date], "Q"),
    "DiaSemana", FORMAT([Date], "dddd")
)


-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ¨ SECCIÃ“N 6: MEDIDAS DE FORMATO (Para tooltips y etiquetas)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 6.1 Etiqueta dinÃ¡mica de Morosidad
Etiqueta_Morosidad = 
VAR Tasa = [Tasa_Morosidad]
RETURN
    SWITCH(
        TRUE(),
        Tasa <= 0.15, "âœ… Bajo Riesgo",
        Tasa <= 0.25, "âš ï¸ Riesgo Medio",
        Tasa <= 0.35, "ğŸ”¶ Riesgo Alto",
        "ğŸ”´ Riesgo CrÃ­tico"
    )

-- 6.2 Tooltip Resumen para GrÃ¡ficos
Tooltip_Resumen = 
"CrÃ©ditos: " & FORMAT([Total_Creditos], "#,0") &
" | Morosidad: " & FORMAT([Tasa_Morosidad], "0.0%") &
" | Monto Riesgo: " & FORMAT([Monto_Riesgo], "#,0 DM")
